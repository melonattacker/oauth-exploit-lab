from flask import Flask, redirect, request, render_template, session
from tinydb import TinyDB, Query, where
from tinydb.table import Document
import os
import random
import string
import urllib.parse
import requests
import base64
import json

app = Flask(__name__)
app.secret_key = os.getenv('SECRET_KEY')

db = TinyDB('../db.json')

users = [
    {
        'name': 'bob',
        'password': 'hoge'
    },
    {
        'name': 'tom',
        'password': 'huga'
    }
]
client = {
    'client_id': 'oauth-client-1',
    'client_secret': 'oauth-client-secret-1',
    'redirect_uris': ['http://localhost:10000/callback'],
    'scope': 'hoge huga'
}
auth_server = {
    'authorization_endpoint': 'http://localhost:10001/authorize',
    'token_endpoint': 'http://auth_server:10001/token',
    'revocation_endpoint': 'http://auth_server:10001/revoke'
}
protected_resource: str = 'http://protected_resource:10002/resource'

def generate_randomstring(size: int) -> str:
    return ''.join(random.SystemRandom().choice(string.ascii_uppercase + string.digits) for _ in range(size))

def build_url(base: str, options: dict) -> str:
    pr = urllib.parse.urlparse(base)
    return str(urllib.parse.urlunparse(pr._replace(query=urllib.parse.urlencode(options, doseq=True))))

def encode_client_credentials(client_id: str, client_secret: str) -> str:
    return base64.b64encode(bytes(urllib.parse.quote(client_id)+':'+urllib.parse.quote(client_secret), 'utf-8')).decode('utf-8')

def insert_to_db(d: dict):
    if len(db.all()) == 0:
        db.insert(d)
    else:
        db.insert(Document(d, doc_id=db.all()[-1].doc_id+1))

@app.route("/", methods=["GET"])
def index():
    if not session.get('name'):
        return redirect('/login')
    
    res = db.search(Query()['name'] == session.get('name')) # sometimes returns wrong result
    rtl = list(filter(lambda x: 'refresh_token' in x, res))
    atl = list(filter(lambda x: 'access_token' in x, res))
    if  len(rtl) == 0 and len(atl) == 0:
        return render_template('index.html', access_token=None, refresh_token=None, scope=None, name=session.get('name'))
    elif len(rtl) != 0 and len(atl) == 0:
        return render_template('index.html', access_token=None, refresh_token=rtl[0]['refresh_token'], scope=rtl[0]['scope'], name=session.get('name'))
    elif len(rtl) == 0 and len(atl) != 0:
        return render_template('index.html', access_token=atl[0]['access_token'], refresh_token=None, scope=atl[0]['scope'], name=session.get('name'))
    else:
        return render_template('index.html', access_token=atl[0]['access_token'], refresh_token=rtl[0]['refresh_token'], scope=atl[0]['scope'], name=session.get('name'))
    
@app.route("/login", methods=["GET", "POST"])
def login():
    if request.method == 'POST':
        for user in users:
            if user['name'] == request.form.get('name'):
                if user['password'] == request.form.get('password'):
                    session['name'] = request.form.get('name')
                    return redirect('/')
        return render_template('error.html', error='invalid username or password')        
    return render_template('login.html')

@app.route("/logout", methods=["POST"])
def logout():
    session["name"] = None
    return redirect("/")

@app.route("/authorize", methods=["GET"])
def authorize():
    if not session.get('name'):
        return redirect('/login')
    
    state = generate_randomstring(32)
    insert_to_db({'state': state, 'user': session.get('name')})
    
    authorize_url: str = build_url(auth_server['authorization_endpoint'], {
        'response_type': 'token',
        'client_id': client['client_id'],
        'redirect_uri': client['redirect_uris'][0],
        'state': state,
        'scope': client['scope']
    })
    print('redirect to:', authorize_url)
    return redirect(authorize_url)

@app.route("/callback", methods=["GET"])
def callback():
    if not session.get('name'):
        return redirect('/login')
    
    if request.args.get('error') != None:
        return render_template('error.html', error=request.args.get('error'))
    
    # check state and session
    State = Query()
    res = db.search(State.state == request.args.get('state'))
    if len(res) == 0:
        return render_template('error.html', error='State value did not match')
    if res[0]['user'] != session.get('name'):
        return render_template('error.html', error='State value did not match')
    
    access_token: str = request.args.get('access_token', '')
    
    if access_token != '':
        return render_template('index.html', access_token=access_token, name=session.get('name'))
    else:   
        return render_template('error.html', error='Unable to fetch access token, server response')

@app.route("/refresh", methods=["GET"])
def refresh_access_token():
    if not session.get('name'):
        return redirect('/login')
    
    Ref = Query()
    res = db.search(Ref.name == session.get('name'))
    rtl = list(filter(lambda x: 'refresh_token' in x, res))
    if len(rtl) == 0:
        return render_template('error.html', error='Missing Refresh Token')
    refresh_token: str = rtl[0]['refresh_token']
    print('Refreshing token %s' % (refresh_token))
    payload = {
        'grant_type': 'refresh_token',
        'refresh_token': refresh_token,
        'redirect_uri': client['redirect_uris'][0]
    }
    headers = {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': 'Basic ' + encode_client_credentials(client['client_id'], client['client_secret'])
    }
    
    access_token: str = None
    scope: str = None
    
    res = requests.post(auth_server['token_endpoint'], data=payload, headers=headers, cookies={'session': request.cookies.get('session')})
    if res.status_code >= 200 and res.status_code < 300:
        access_token = res.json()['access_token']
        refresh_token = res.json()['refresh_token']
        scope = res.json()['scope']
        print('Got access token %s' % (access_token))
        print('Got refresh token %s' % (refresh_token))
        print('Got scope %s' % (scope))
        return render_template('index.html', access_token=access_token, refresh_token=refresh_token, scope=scope, name=session.get('name'))
    else:   
        print('No refresh token, asking the user to get a new access token')
        return render_template('index.html', access_token=access_token, refresh_token=refresh_token, scope=scope, name=session.get('name'))
    
@app.route("/fetch_resource", methods=["GET"])
def fetch_resource():
    if not session.get('name'):
        return redirect('/login')
    
    access_token = request.args.get('access_token')
    if access_token == None:
        return render_template('error.html', error='Missing Access Token')

    print('Making request with access token %s' % (access_token))
    headers = {
        'Authorization': 'Bearer ' + access_token
    }
    res = requests.post(protected_resource, headers=headers, cookies={'session': request.cookies.get('session')})
    
    if res.status_code >= 200 and res.status_code < 300:
        return render_template('data.html', resource=json.dumps(res.json()))
    else:   
        return render_template('error.html', error=res.status_code)

@app.route("/revoke", methods=["POST"])
def revoke():
    if not session.get('name'):
        return redirect('/login')
    
    token = request.form.get('token')
    token_type_hint = request.form.get('token_type_hint')
    payload = {
        'token': token,
        'token_type_hint': token_type_hint
    }
    headers = {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': 'Basic ' + encode_client_credentials(client['client_id'], client['client_secret'])
    }
    print('Revoke token type %s: %s' % (token_type_hint, token))
    res = requests.post(auth_server['revocation_endpoint'], data=payload, headers=headers)
    
    if res.status_code >= 200 and res.status_code < 300:
        return redirect('/')
    else:   
        return render_template('error.html', error=res.status_code)
    
if __name__ == '__main__':
    app.run(host="0.0.0.0", port=10000)
from flask import Flask, request, Response, session
from typing import List
from tinydb import TinyDB, Query
import json
import os

app = Flask(__name__)
app.secret_key = os.getenv('SECRET_KEY')

db = TinyDB('../db.json')

resource = {
    'bob': {
        'name': 'Protected Resource for bob',
        'description': 'bob bob bob'   
    }, 
    'tom': {
        'name': 'Protected Resource for tom',
        'description': 'tom tom tom'   
    }
}

scope = ['hoge', 'huga', 'piyo']

@app.route("/resource", methods=["POST"])
def get_resource():
    auth = request.headers.get("authorization")
    in_token = None
    if auth != None and auth.lower().find('bearer') == 0:
        in_token = auth[len("bearer "):]
    elif request.form != None and request.form.get('access_token') != None:
        in_token = request.form.get('access_token')
    elif request.args != None and request.args.get('access_token') != None:
        in_token = request.args.get('access_token')
    
    print('Incoming token: %s' % (in_token))
    
    res = db.get(Query()['access_token'] == in_token)
    if res != None:
        print('We found a matching token: %s' % (in_token))
        # user validation
        if session.get('name') != res['name']:
            print('User and access token holder do not match.')
            return Response(status=401)
        
        res_resource = resource.get(res['name'])
        res_resource['scope'] = []
        lscope : List[str] = res['scope'].split(' ') if  res['scope'] != None else []
        for s in lscope:
            if s in scope:
                res_resource['scope'].append(s)
        return Response(response=json.dumps(res_resource), status=200)
    else:
        print('No matching token was found.')
        return Response(status=401)
        

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=10002)